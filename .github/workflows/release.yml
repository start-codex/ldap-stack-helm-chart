name: Release

on:
  push:
    branches: [main]
    paths:
      - 'Chart.yaml'
      - 'values.yaml'
      - 'values.schema.json'
      - 'templates/**'
      - 'public-key.asc'
      - 'artifacthub-repo.yml'
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: release
  cancel-in-progress: false

jobs:
  ci:
    name: CI
    uses: ./.github/workflows/ci.yml

  release:
    name: Release & Deploy
    runs-on: ubuntu-latest
    needs: ci
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.16.0

      - name: Import GPG key and create legacy keyring
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        run: |
          if [ -n "$GPG_PRIVATE_KEY" ]; then
            # Configure GPG for non-interactive use BEFORE import
            mkdir -p ~/.gnupg
            chmod 700 ~/.gnupg
            echo "allow-loopback-pinentry" > ~/.gnupg/gpg-agent.conf
            echo "pinentry-mode loopback" > ~/.gnupg/gpg.conf
            gpg-connect-agent reloadagent /bye 2>/dev/null || true

            # Import key to GnuPG
            echo "$GPG_PRIVATE_KEY" | gpg --batch --import

            # Export to legacy format required by Helm (with passphrase)
            gpg --export > ~/.gnupg/pubring.gpg
            echo "$GPG_PASSPHRASE" | gpg --batch --yes --pinentry-mode loopback \
              --passphrase-fd 0 --export-secret-keys > ~/.gnupg/secring.gpg

            # Verify keyring was created
            if [ -s ~/.gnupg/secring.gpg ]; then
              echo "GPG_AVAILABLE=true" >> $GITHUB_ENV
              echo "GPG key imported and legacy keyring created"
              ls -la ~/.gnupg/*.gpg
            else
              echo "GPG_AVAILABLE=false" >> $GITHUB_ENV
              echo "Failed to create legacy keyring"
            fi
          else
            echo "GPG_AVAILABLE=false" >> $GITHUB_ENV
            echo "No GPG key provided"
          fi

      - name: Package Chart
        env:
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        run: |
          mkdir -p .packages public

          # Download existing charts (only if valid)
          wget -q https://start-codex.github.io/ldap-stack-helm-chart/index.yaml -O existing-index.yaml 2>/dev/null || true

          # Validate existing index is not empty and contains valid YAML
          if [ -f existing-index.yaml ] && [ -s existing-index.yaml ] && grep -q "apiVersion:" existing-index.yaml; then
            echo "Found valid existing index.yaml"
            grep -o 'https://start-codex.github.io/ldap-stack-helm-chart/[^"]*\.tgz' existing-index.yaml | while read url; do
              [ -n "$url" ] && wget -q "$url" -O "public/$(basename $url)" || true
            done
            cp existing-index.yaml .packages/
          else
            echo "No valid existing index.yaml found, will create new index"
            rm -f existing-index.yaml
          fi

          # Package with signature if GPG available
          if [ "$GPG_AVAILABLE" = "true" ] && [ -n "$GPG_PASSPHRASE" ]; then
            echo "Packaging with GPG signature..."
            echo "$GPG_PASSPHRASE" | helm package . -d .packages \
              --sign \
              --key "cloud@startcodex.com" \
              --keyring ~/.gnupg/secring.gpg \
              --passphrase-file /dev/stdin

            if [ -f .packages/*.prov ]; then
              echo "Chart signed successfully"
              ls -la .packages/*.prov
            else
              echo "Signature failed, packaging without signature"
              helm package . -d .packages
            fi
          else
            echo "Packaging without signature..."
            helm package . -d .packages
          fi

          # Generate index
          if [ -f .packages/existing-index.yaml ]; then
            helm repo index .packages --url https://start-codex.github.io/ldap-stack-helm-chart --merge .packages/existing-index.yaml
          else
            helm repo index .packages --url https://start-codex.github.io/ldap-stack-helm-chart
          fi

          # Copy files to public
          cp .packages/*.tgz public/
          cp .packages/*.prov public/ 2>/dev/null || true
          cp .packages/index.yaml public/
          cp README.md artifacthub-repo.yml public/
          cp public-key.asc public/ 2>/dev/null || true

      - name: Generate index.html
        run: |
          VERSION=$(grep '^version:' Chart.yaml | awk '{print $2}')
          cat > public/index.html << 'HTMLEOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="utf-8">
            <meta name="viewport" content="width=device-width, initial-scale=1">
            <title>LDAP Stack Helm Chart</title>
            <style>
              * { box-sizing: border-box; }
              body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; line-height: 1.6; color: #24292f; }
              .header { text-align: center; padding: 40px 0; border-bottom: 1px solid #d0d7de; }
              .header img { width: 100px; }
              h1 { margin: 16px 0 8px; }
              .badges { margin: 16px 0; }
              .badge { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 500; margin: 4px; }
              .badge-version { background: #0969da; color: white; }
              .badge-signed { background: #1a7f37; color: white; }
              .section { margin: 32px 0; }
              h2 { border-bottom: 1px solid #d0d7de; padding-bottom: 8px; }
              pre { background: #f6f8fa; padding: 16px; border-radius: 6px; overflow-x: auto; }
              code { font-family: ui-monospace, SFMono-Regular, 'SF Mono', Menlo, monospace; font-size: 14px; }
              a { color: #0969da; text-decoration: none; }
              a:hover { text-decoration: underline; }
              ul { padding-left: 24px; }
              li { margin: 8px 0; }
              .footer { text-align: center; padding: 32px 0; color: #57606a; border-top: 1px solid #d0d7de; margin-top: 40px; }
            </style>
          </head>
          <body>
            <div class="header">
              <img src="https://www.openldap.org/images/openldap-logo-96x96.png" alt="OpenLDAP">
              <h1>LDAP Stack Helm Chart</h1>
              <p>OpenLDAP + phpLDAPadmin + Keycloak for Kubernetes</p>
              <div class="badges">
                <span class="badge badge-version">v${VERSION}</span>
                <span class="badge badge-signed">Signed</span>
              </div>
            </div>

            <div class="section">
              <h2>Quick Start</h2>
              <pre><code>helm repo add ldap-stack https://start-codex.github.io/ldap-stack-helm-chart
          helm repo update
          helm install my-ldap ldap-stack/ldap-stack \
            --set openldap.config.organisation="My Company" \
            --set openldap.config.domain="mycompany.com" \
            --set openldap.config.adminPassword="secure-password" \
            --set keycloak.admin.username="admin" \
            --set keycloak.admin.password="secure-password"</code></pre>
            </div>

            <div class="section">
              <h2>Features</h2>
              <ul>
                <li>OpenLDAP 2.6.x with startcodex/openldap image</li>
                <li>phpLDAPadmin web interface</li>
                <li>Keycloak Identity Provider with LDAP Federation</li>
                <li>Automatic LDAP Bootstrap (OUs creation)</li>
                <li>Production-ready: NetworkPolicy, PDB, ServiceMonitor</li>
                <li>Multiple service types: ClusterIP, NodePort, LoadBalancer</li>
              </ul>
            </div>

            <div class="section">
              <h2>Links</h2>
              <ul>
                <li><a href="https://github.com/start-codex/ldap-stack-helm-chart">GitHub Repository</a></li>
                <li><a href="https://artifacthub.io/packages/helm/ldap-stack/ldap-stack">Artifact Hub</a></li>
                <li><a href="https://www.openldap.org/">OpenLDAP Official</a></li>
                <li><a href="https://www.keycloak.org/">Keycloak Official</a></li>
              </ul>
            </div>

            <div class="section">
              <h2>Files</h2>
              <ul>
                <li><a href="index.yaml">index.yaml</a></li>
                <li><a href="README.md">README.md</a></li>
                <li><a href="artifacthub-repo.yml">artifacthub-repo.yml</a></li>
              </ul>
            </div>

            <div class="footer">
              Made with care by <a href="https://github.com/start-codex">StartCodex</a>
            </div>
          </body>
          </html>
          HTMLEOF
          sed -i "s/\${VERSION}/$VERSION/g" public/index.html

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: public

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
